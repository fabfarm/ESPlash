<!DOCTYPE HTML>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- TODO: grab fontawesomes & server locally -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/style.css" />
</head>

<body>
    <h2>Fab Farm Irrigation System</h2>

    <img src="/logo.jpeg" style="height:400px;" /></p>
        <i class="fas fa-clock"></i>
        <span class="dht-labels">Farm Time:</span>
        <span id="currentTime"></span>
        <br/>
    <hr>
        <i class="fas fa-thermometer-half"></i>
        <span id="temperature" class="dht-labels">Temperature</span>
        <sup class="units">&deg;C</sup>
    <hr>
        <i class="fas fa-tint"></i>
        <span class="dht-labels">Humidity</span>
        <span id="humidity"></span>
        <sup class="units">%</sup>
    <hr/>
    <div>
    <div id="main"></div>

 
</body>
<script>
    // keep global json object - we'll update this on element change

    var jsonData; 

    // gets called anytime anything changes :)
    function update(obj) {
        jsonData.data.override = document.getElementById("jasonData.data.override").checked ? 1 : 0;
        console.log(document.getElementById("jasonData.data.override"));
        for(var i = 0; i < jsonData.relays.length; i++) { 
            jsonData.relays[i].isEnabled = document.getElementById(`jsonData.relays[${i}].isEnabled`).checked ? 1 : 0;
            for(j = 0; j < jsonData.relays[i].times.length; j++) {
                jsonData.relays[i].times[j].duration  = document.getElementById(`jsonData.relays[${i}].times[${j}].duration`).value;
                jsonData.relays[i].times[j].startTime = document.getElementById(`jsonData.relays[${i}].times[${j}].startTime`).value;
            }
        }

        var json = JSON.stringify(jsonData);
        var xmlhttp = new XMLHttpRequest();   
        xmlhttp.open("POST", "/updateData");
        xmlhttp.setRequestHeader("Content-Type", "application/json;");
        xmlhttp.send(json);
    }

    /* Currently we load this once from the server & it's working well.
    Once we start pinging the server for updates, we'll run into the issue where this keep running over and over
    again and will keep adding elements to the page ! We need to fix this so we build the page based on the json
    and either
    a) rebuild it per ping (?)
    b) only update the relevant elements if it's already built
    */
    
    //setInterval(function() {

        //TODO: change the above to make *1* request and get json back
        var r3 = new XMLHttpRequest();
        r3.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                //document.getElementById("getData").innerHTML = this.responseText;
                jsonData = JSON.parse(this.responseText);
                document.getElementById("currentTime").innerText = jsonData.data.currentTime;
                document.getElementById("temperature").innerText = jsonData.data.temperature;
                document.getElementById("humidity").innerText = jsonData.data.humidity;

                var html = `Manual 
                        <label class="switch">
                            <input type="checkbox" ${jsonData.data.override ? "checked" : ""} 
                             onChange="update(this);" id="jasonData.data.override"/>
                            <span class="slider"></span> 
                        </label> Automatic`;

                for(var i = 0; i  < jsonData.relays.length; i++) {
                    var relay = jsonData.relays[i];
                    html += `<hr/><div>Relay name:<b>${relay.name}</b> (pin ${relay.pin})</div>
                                isRunning: [${relay.isRunning}]
                                / Relay enabled: <span class="w3-hide-small">
                                    <label class="switch">
                                     <input id="jsonData.relays[${i}].isEnabled" type="checkbox" ${relay.isEnabled ? "checked": ""} 
                                        onchange="update(this);"/>
                                      <span class="slider"/>
                                    </label>
                                </span>
                                <div>Schedules for relay:</div>`;

                    // build list of schedules for this relay
                    for(var j = 0; j < relay.times.length; j++) {
                        time = relay.times[j];
                        //console.log(time)
                        var times = `<div style="width:100px;"></div> 
                                    <label for="time"></label>
                                        <div>
                                            <span>Time ${j+1}</span>
                                            <input id="jsonData.relays[${i}].times[${j}].startTime" type="time" style="width:100px;" 
                                                    onChange="update(this);" 
                                                    required value="${time.startTime}" />
                                            <input id="jsonData.relays[${i}].times[${j}].duration" type="range" onChange="update(this);" 
                                                    min="0" max="60" value="${time.duration}" step="1" class="slider2">
                                        </div>
                        `;

                        html += times;
                    }
                }                    

                var main = document.getElementById("main");
                main.innerHTML = html; //this will REBUILD the page per ping (?)

            };
        }; 
        r3.open("GET", "/getData", true);
        //r3.open("GET", "sample.json", true);
        r3.send();

    //}, 10000);

</script>

</html>
